![EBSI Logo](https://ec.europa.eu/cefdigital/wiki/images/logo/default-space-logo.svg)

# EBSI DID JWT Library

> EBSI did-jwt library allows you to sign and verify [JSON Web Tokens (JWT)](https://tools.ietf.org/html/rfc7519) using ES256K, ES256K-R and Ed25519 algorithms for the EBSI.

> Public keys are resolved using the [Decentralized ID (DID)](https://w3c-ccg.github.io/did-spec/#decentralized-identifiers-dids) of the signing identity of the claim, which is passed as the `iss` attribute of the encoded JWT.

## Table of Contents

1. [Installation](#Installation)
2. [DID methods](#DID-methods)
3. [Example](#Example)
4. [Library Test](#Library-Test)
5. [Licensing](#Licensing)

## Installation

```bash
npm install @cef-ebsi/did-jwt
```

or if you use `yarn`

```bash
yarn add @cef-ebsi/did-jwt
```

## DID methods

We currently support the following DID methods:

- [`ebsi`](https://github.com/validatedid/ebsi-did-resolver)
- [`ethr`](https://github.com/uport-project/ethr-did-resolver)
- [`uport`](https://github.com/uport-project/uport-did-resolver)
- [`https`](https://github.com/uport-project/https-did-resolver)
- [`nacl`](https://github.com/uport-project/nacl-did)
- [`muport`](https://github.com/3box/muport-did-resolver)

You will need to install each one you need to support. See each method for how to configure it.

## Example

### 1. Create a did-JWT

[createJWT](docs/reference/index.md#did-jwtjwtcreatejwtpayload-config--promiseobject-error)

In practice you should secure the key passed to SimpleSigner. The key provided in code below is for informational purposes; you will need to create an application identity at [My Apps](http://developer.uport.me/myapps) or use our uport-credentials library to [generate an ethereum key pair](https://github.com/uport-project/uport-credentials/blob/develop/docs/guides/index.md#generate-an-ethereum-keypair).

```js
const didJWT = require("@cef-ebsi/did-jwt");
const signer = didJWT.SimpleSigner(
  "278a5de700e29faae8e40e366ec5012b5ec63d36ec77e8a2417154cc1d25383f"
);

let jwt = "";
didJWT
  .createJWT(
    {
      aud: "did:ebsi:0xf3beac30c498d9e26865f34fcaa57dbb935b0d74",
      exp: 1957463421,
      name: "name",
    },
    {
      alg: "ES256K-R",
      issuer: "did:ebsi:0xf3beac30c498d9e26865f34fcaa57dbb935b0d74",
      signer,
    }
  )
  .then((response) => {
    jwt = response;
  });

console.log(jwt);
```

### 2. Decode a did-JWT

Try decoding the JWT. You can also do this using [jwt.io](jwt.io)

```js
//pass the jwt from step 1
let decoded = didJWT.decodeJWT(jwt);
console.log(decoded);
```

Once decoded a did-JWT will resemble:

```js
{
  header: { typ: 'JWT', alg: 'ES256K-R' },
  payload: {
    iat: 1571692233,
    exp: 1957463421,
    aud: 'did:ebsi:0xf3beac30c498d9e26865f34fcaa57dbb935b0d74',
    name: 'name',
    iss: 'did:ebsi:0xf3beac30c498d9e26865f34fcaa57dbb935b0d74'
  },
  signature: 'kkSmdNE9Xbiql_KCg3IptuJotm08pSEeCOICBCN_4YcgyzFc4wIfBdDQcz76eE-z7xUR3IBb6-r-lRfSJcHMiAA',
  data: 'eyJ0eXAiOiJKV1QiLCJhbGciOiJFUzI1NkstUiJ9.eyJpYXQiOjE1NzE2OTIyMzMsImV4cCI6MTk1NzQ2MzQyMSwiYXVkIjoiZGlkOmV0aHI6MHhmM2JlYWMzMGM0OThkOWUyNjg2NWYzNGZjYWE1N2RiYjkzNWIwZDc0IiwibmFtZSI6InVQb3J0IERldmVsb3BlciIsImlzcyI6ImRpZDpldGhyOjB4ZjNiZWFjMzBjNDk4ZDllMjY4NjVmMzRmY2FhNTdkYmI5MzViMGQ3NCJ9'
}
```

### 4. Verify a did-JWT

[verifyJWT](/docs/reference/index.md#did-jwtjwtverifyjwtjwt-config--promiseobject-error)

You need to provide a did-resolver for the verify function. For this example we will use ethr-did, but there are other methods available above. For more information on configuring the Resolver object please see [did-resolver](https://github.com/decentralized-identity/did-resolver#configure-resolver-object)

```bash
npm install ebsi-did-resolver
```

```js
const Resolver = require("did-resolver");
const ebsiDid = require("ebsi-did-resolver").getResolver();

let resolver = new Resolver.Resolver(ebsiDid);

let verifiedResponse = {};
// pass the JWT from step 1 & 2
didJWT
  .verifyJwt(jwt, {
    resolver: resolver,
    audience: "did:ebsi:0xf3beac30c498d9e26865f34fcaa57dbb935b0d74",
  })
  .then((response) => {
    verifiedResponse = response;
  });

console.log(verifiedResponse);
```

A verified did-JWT returns an object resembling:

```js
{
  payload: {
    iat: 1571692448,
    exp: 1957463421,
    aud: 'did:ebsi:0xf3beac30c498d9e26865f34fcaa57dbb935b0d74',
    name: 'name',
    iss: 'did:ebsi:0xf3beac30c498d9e26865f34fcaa57dbb935b0d74'
  },
  doc: {
    '@context': 'https://w3id.org/did/v1',
    id: 'did:ebsi:0xf3beac30c498d9e26865f34fcaa57dbb935b0d74',
    publicKey: [ [Object] ],
    authentication: [ [Object] ]
  },
  issuer: 'did:ebsi:0xf3beac30c498d9e26865f34fcaa57dbb935b0d74',
  signer: {
    id: 'did:ethr:0xf3beac30c498d9e26865f34fcaa57dbb935b0d74#owner',
    type: 'Secp256k1VerificationKey2018',
    owner: 'did:ethr:0xf3beac30c498d9e26865f34fcaa57dbb935b0d74',
    ethereumAddress: '0xf3beac30c498d9e26865f34fcaa57dbb935b0d74'
  },
  jwt: 'eyJ0eXAiOiJKV1QiLCJhbGciOiJFUzI1NkstUiJ9.eyJpYXQiOjE1NzE2OTI0NDgsImV4cCI6MTk1NzQ2MzQyMSwiYXVkIjoiZGlkOmV0aHI6MHhmM2JlYWMzMGM0OThkOWUyNjg2NWYzNGZjYWE1N2RiYjkzNWIwZDc0IiwibmFtZSI6InVQb3J0IERldmVsb3BlciIsImlzcyI6ImRpZDpldGhyOjB4ZjNiZWFjMzBjNDk4ZDllMjY4NjVmMzRmY2FhNTdkYmI5MzViMGQ3NCJ9.xd_CSWukS6rK8y7GVvyH_c5yRsDXojM6BuKaf1ZMg0fsgpSBioS7jBfyk4ZZvS0iuFu4u4_771_PNWvmsvaZQQE'
}
```

### 4. Verify ebsi did-JWT

For ebsi jwt we are using the `ES256K-R` algorithm that allows to recover the publickey based on the signature and the data. That's why for now the ebsi-resolver doesn't reply with the `ethereumAddress` inside the `publickey` object.
Indeed we are recovering the pubkey from the signature and then we are converting it to an eth address. Finally
we are comparing that recovered eth address against the `ethereumAddress` return by the resolver to verify the signature.

The `ebsiVerifyJwt` function is used to verify a DID JWT. In the options, the `resolver` can be an url to connect with the DID api, or an object resolver like the example in the previous section.

```js
const urlResolver = "https://api.ebsi.xyz/did/v1/identifiers";

let verifiedResponse = {};
// pass the JWT from step 1 & 2
didJWT
  .ebsiVerifyJwt(jwt, {
    resolver: urlResolver,
    audience: "did:ebsi:0xf3beac30c498d9e26865f34fcaa57dbb935b0d74",
    callbackUrl: "ebsi-wallet",
  })
  .then((response) => {
    verifiedResponse = response;
  });

console.log(verifiedResponse);
```

## Library Test

Create an `.env` file using `.env.example` and update the env variables.

```bash
# unit tests
$ yarn test
```

## Licensing

Copyright (c) 2019 European Commission
Licensed under the EUPL, Version 1.2 or - as soon they will be approved by the European Commission - subsequent versions of the EUPL (the "Licence");
You may not use this work except in compliance with the Licence.
You may obtain a copy of the Licence at:

- <https://joinup.ec.europa.eu/page/eupl-text-11-12>

Unless required by applicable law or agreed to in writing, software distributed under the Licence is distributed on an "AS IS" basis, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the Licence for the specific language governing permissions and limitations under the Licence.

Library based on [did-jwt](https://github.com/decentralized-identity/did-jwt) library licensed under [Apache 2.0](LICENSE.txt) Copyright 2020 decentralized identity.
Here are the changes applied to the original library:

- remove uport-base64url dependency in favor of bas64url
- use of tweetnacl-ts dependency instead of tweetnacl
- Use of the factory pattern for signer and verifier algorithm
- Add unit tests
