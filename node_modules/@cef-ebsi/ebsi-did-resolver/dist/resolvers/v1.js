"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.resolve = void 0;
const axios_1 = __importDefault(require("axios"));
const errors_1 = require("../errors");
const constants_1 = require("../constants");
const AXIOS_TIMEOUT = 15000;
const SUPPORTED_CONTENT_TYPES = [
    "application/did+ld+json",
    "application/did+json",
];
function isSupportedContentType(contentType) {
    return SUPPORTED_CONTENT_TYPES.includes(contentType);
}
async function get(url, contentType, timeout) {
    try {
        const response = await axios_1.default.get(url, {
            headers: {
                accept: contentType,
            },
            timeout: timeout || AXIOS_TIMEOUT,
        });
        return response.data;
    }
    catch (e) {
        let message = "";
        if (axios_1.default.isAxiosError(e)) {
            try {
                const { detail, title } = e.response?.data;
                message = detail || title;
            }
            catch (err) {
                message = e.message;
            }
            throw new errors_1.ProblemDetailsError(e.response?.status || 500, e.response?.statusText || "", {
                detail: message,
            });
        }
        throw e;
    }
}
async function resolve(did, registry, didResolutionOptions) {
    if (!registry) {
        return {
            didDocument: null,
            didDocumentMetadata: {},
            didResolutionMetadata: {
                error: constants_1.DID_RESOLUTION_ERROR_CODES.CONFIGURATION_ERROR,
                message: "A DID registry must be defined in order to resolve EBSI DID method v1 documents",
            },
        };
    }
    let accept = "application/did+ld+json";
    if (didResolutionOptions && didResolutionOptions.accept) {
        if (!isSupportedContentType(didResolutionOptions.accept)) {
            return {
                didDocument: null,
                didDocumentMetadata: {},
                didResolutionMetadata: {
                    error: constants_1.DID_RESOLUTION_ERROR_CODES.REPRESENTATION_NOT_SUPPORTED,
                    message: `Representation ${didResolutionOptions.accept} is not supported. Valid representations include: ${SUPPORTED_CONTENT_TYPES.join(", ")}`,
                },
            };
        }
        accept = didResolutionOptions.accept;
    }
    // Resolve Legal Entity DID
    try {
        const timeout = didResolutionOptions && typeof didResolutionOptions.timeout === "number"
            ? didResolutionOptions.timeout
            : AXIOS_TIMEOUT;
        const didDocument = await get(`${registry}/${did}`, accept, timeout);
        return {
            didDocument,
            didDocumentMetadata: {},
            didResolutionMetadata: { contentType: accept },
        };
    }
    catch (e) {
        let error = constants_1.DID_RESOLUTION_ERROR_CODES.UNKNOWN_ERROR;
        let message = "";
        if (e instanceof errors_1.ProblemDetailsError) {
            if (e.status === 400) {
                error = constants_1.DID_RESOLUTION_ERROR_CODES.INVALID_DID;
                message = e.detail || e.title || "Bad Request";
            }
            else if (e.status === 404) {
                error = constants_1.DID_RESOLUTION_ERROR_CODES.NOT_FOUND;
                message = e.detail || e.title || "Not Found";
            }
            else if (e.status === 500) {
                error = constants_1.DID_RESOLUTION_ERROR_CODES.INTERNAL_SERVER_ERROR;
                message = e.detail || e.title || "Internal Server Error";
            }
            else {
                message = e.detail || e.title || "unknown";
            }
        }
        else if (e instanceof Error) {
            message = e.message;
        }
        return {
            didDocument: null,
            didDocumentMetadata: {},
            didResolutionMetadata: {
                error,
                message: `${message} | Registry used: ${registry}`,
            },
        };
    }
}
exports.resolve = resolve;
exports.default = resolve;
//# sourceMappingURL=v1.js.map