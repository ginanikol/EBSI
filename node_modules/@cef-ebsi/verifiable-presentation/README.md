![EBSI Logo](https://ec.europa.eu/digital-building-blocks/wikis/images/logo/default-space-logo.svg)

# Verifiable Presentation Library

Create and verify EBSI-compliant W3C Verifiable Presentations in JWT format.

This library extends the [@transmute/json-web-signature
](https://github.com/transmute-industries/verifiable-data/tree/v0.7.0-unstable.80/packages/json-web-signature) and [@transmute/vc.js](https://github.com/transmute-industries/verifiable-data/tree/v0.7.0-unstable.80/packages/vc.js) libraries by applying additional validation rules. For more details, see [EBSI Verifiable Credentials Playbook](https://ec.europa.eu/digital-building-blocks/wikis/display/EBSIDOC/EBSI+Verifiable+Credentials+Playbook).

Note: this library only supports [`2020-12` JSON Schemas](https://json-schema.org/draft/2020-12/json-schema-core.html).

## Table of Contents

1. [Installation](#Installation)
2. [Usage](#Usage)
3. [Development](#Development)
4. [Licensing](#Licensing)

## Installation

Using npm:

```bash
$ npm i --save @cef-ebsi/verifiable-presentation
```

Using yarn:

```bash
$ yarn add @cef-ebsi/verifiable-presentation
```

## Usage

### Creating VP JWTs

#### Prerequisites

Create an `EbsiIssuer` object to sign VP JWTs:

```typescript
import type { EbsiIssuer } from "@cef-ebsi/verifiable-presentation";

const signer: EbsiIssuer({
  did: "did:ebsi:zcWoBr6PUWmtEAJBKTNMuL1",
  kid: "did:ebsi:zcWoBr6PUWmtEAJBKTNMuL1#keys-1",
  publicKeyJwk: <JWK>,
  privateKeyJwk: <JWK>,
  alg: "ES256K",
})
```

In order to create a valid VP JWT, the signer MUST either be a Legal Entity (LE) registered in the [DID Registry](https://api-pilot.ebsi.eu/docs/apis/did-registry/latest) (EBSI DID method v1), or a Natural Person. For Natural Persons, the `did:ebsi` method v2 (legacy) and `did:key` method (with the codec `jwk_jcs-pub`) are supported.

#### Creating a Verifiable Credential

Specify a payload matching the `EbsiVerifiablePresentation` interface. Create a JWT by signing it with the previously configured issuer and a target audience using the `createVerifiablePresentationJwt` function:

```typescript
import {
  createVerifiablePresentationJwt,
  EbsiVerifiablePresentation,
} from "@cef-ebsi/verifiable-presentation";

const vpPayload: EbsiVerifiablePresentation = {
  id: "urn:did:123456",
  "@context": ["https://www.w3.org/2018/credentials/v1"],
  type: ["VerifiablePresentation"],
  holder: "did:ebsi:zcWoBr6PUWmtEAJBKTNMuL1",
  // Note: `verifiableCredential` only accept valid VC JWTs (strings)
  verifiableCredential: [
    "eyJraWQiOiJkaWQ6ZWJzaTp6Y1dvQnI...fqtk4SjRA7Cwu-euNohIq4a_63dCKL_xqfWZ3SoBLsBBu0Q",
  ],
};

const audience = "did:ebsi:zwWmyuVKGnQ68EZg3JYZhDG";

const vpOptions = {
  // REQUIRED. EBSI URI Authority ([userinfo "@"] host [":" port])
  ebsiAuthority: "api-test.ebsi.eu",

  // OPTIONAL. EBSI environment configuration.
  // This option allows you to override the default URLs (TIR, DIDR, TSR).
  ebsiEnvConfig: {
    didRegistry: "https://api-test.ebsi.eu/did-registry/v5/identifiers",
    trustedIssuersRegistry:
      "https://api-test.ebsi.eu/trusted-issuers-registry/v5/issuers",
    trustedPoliciesRegistry:
      "https://api-test.ebsi.eu/trusted-policies-registry/v3/users",
  },

  // OPTIONAL. User-defined VP JWT `nbf`.
  // If none is provided, fallback to `payload.verifiableCredential` JWTs highest `nbf`.
  nbf: 1686048193,

  // OPTIONAL. User-defined VP JWT `exp`.
  // If none is provided, fallback to `payload.verifiableCredential` JWTs lowest `exp`.
  exp: 1686078193,

  // OPTIONAL. The nonce is used to stop a replay attack.
  nonce: "nonce",

  // OPTIONAL. Verification relationship.
  // One of "assertionMethod" | "authentication" | "capabilityDelegation" | "capabilityInvocation"
  // Default: "authentication"
  proofPurpose: "authentication",

  // OPTIONAL. Timeout after which the requests made by the library will fail. Default: 15 seconds
  timeout: 15_000,

  // OPTIONAL. List of trusted hostnames. To be used if the Core Services APIs are hosted on a custom host for instance.
  // If `trustedHostnames` is not defined, the default trusted domains are: "api-test.ebsi.eu", "api-conformance.ebsi.eu", and "api-pilot.ebsi.eu"
  trustedHostnames: ["api.example.net"],

  // OPTIONAL. Determines whether to validate the Verifiable Presentation payload or not.
  // Validation is active by default.
  // Note: even when skipValidation is set to true, the payload must be a valid EBSI Verifiable Presentation.
  skipValidation: false,

  // OPTIONAL. Determines whether to validate the accreditations of the VC issuer or not.
  // Validation is active by default.
  skipAccreditationsValidation: false,

  // OPTIONAL. Determines whether to validate the credential status or not.
  // Validation is active by default.
  skipStatusValidation: false,
};

const vpJwt = await createVerifiablePresentationJwt(
  vpPayload,
  signer,
  audience,
  vpOptions
);

console.log(vpJwt);
// eyJraWQiOiJkaWQ6ZWJzaTp6eEdk...BjHQuXchyO3G6ZrpwzFAHVbmU94aIgcOBKPM1JSp33OR8Q
```

### Verifying JWTs

#### Prerequisites

Pass in a VP JWT to verify and the target audience using the `verifyPresentationJwt` function:

```typescript
import { verifyPresentationJwt } from "@cef-ebsi/verifiable-presentation";

const vpJwt =
  "eyJraWQiOiJkaWQ6ZWJzaTp6eEdk...BjHQuXchyO3G6ZrpwzFAHVbmU94aIgcOBKPM1JSp33OR8Q";
const audience = "did:ebsi:zwWmyuVKGnQ68EZg3JYZhDG";
const options = {
  // REQUIRED. EBSI URI Authority ([userinfo "@"] host [":" port])
  ebsiAuthority: "api-test.ebsi.eu",

  // OPTIONAL. EBSI environment configuration.
  // This option allows you to override the default URLs (TIR, DIDR, TSR).
  ebsiEnvConfig: {
    didRegistry: "https://api-test.ebsi.eu/did-registry/v5/identifiers",
    trustedIssuersRegistry:
      "https://api-test.ebsi.eu/trusted-issuers-registry/v5/issuers",
    trustedPoliciesRegistry:
      "https://api-test.ebsi.eu/trusted-policies-registry/v3/users",
  },

  // OPTIONAL. Timeout after which the requests made by the library will fail. Default: 15 seconds
  timeout: 15_000,

  // OPTIONAL. List of trusted hostnames. To be used if the Core Services APIs are hosted on a custom host for instance.
  // If `trustedHostnames` is not defined, the default trusted domains are: "api-test.ebsi.eu", "api-conformance.ebsi.eu", and "api-pilot.ebsi.eu"
  trustedHostnames: ["api.example.net"],

  // OPTIONAL. Unix timestamp. Optional comparison date.
  // For the JWT to be valid, `nbf` ≤ `validAt` ≤ `exp`.
  validAt: 1686048193,

  // OPTIONAL. Determines whether or not to validate the issuer's accreditations when `termsOfUse` is missing. Default: false
  validateAccreditationWithoutTermsOfUse: false,

  // OPTIONAL. Determines whether to validate the accreditations of the VC issuer or not.
  // Validation is active by default.
  skipAccreditationsValidation: false,

  // OPTIONAL. Determines whether to validate the credential status or not.
  // Validation is active by default.
  skipStatusValidation: false,

  // OPTIONAL. Determines whether to validate the signature of the VP JWT or not.
  // Validation is active by default.
  skipSignatureValidation: false,

  // OPTIONAL. Determines whether to validate the resolution of the VP holder DID or not.
  // Validation is active by default.
  skipHolderDidResolutionValidation: false,

  // OPTIONAL. Verification relationship.
  // One of "assertionMethod" | "authentication" | "capabilityDelegation" | "capabilityInvocation"
  // Default: "authentication"
  proofPurpose: "authentication",
};

const verifiedVp = await verifyPresentationJwt(vpJwt, audience, options);

console.log(verifiedVp);
/*
{
    id: "urn:did:123456",
    "@context": ["https://www.w3.org/2018/credentials/v1"],
    type: ["VerifiablePresentation"],
    holder: "did:ebsi:zxGdqT9vHpvXbNehnXbd6g7",
    verifiableCredential: [
      "eyJraWQiOiJkaWQ6ZWJzaTp6Y1dvQnI...fqtk4SjRA7Cwu-euNohIq4a_63dCKL_xqfWZ3SoBLsBBu0Q",
    ],
}
*/
```

## Development

### Linting

```bash
$ yarn lint
```

### Auditing

```bash
$ yarn run audit
```

### Testing

```bash
$ yarn test
```

## Licensing

Copyright (c) 2019 European Commission

Licensed under the EUPL, Version 1.2 or - as soon they will be approved by the European Commission - subsequent versions of the EUPL (the "Licence");

You may not use this work except in compliance with the Licence.

You may obtain a copy of the Licence at:

- <https://joinup.ec.europa.eu/page/eupl-text-11-12>

Unless required by applicable law or agreed to in writing, software distributed under the Licence is distributed on an "AS IS" basis, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the Licence for the specific language governing permissions and limitations under the Licence.
